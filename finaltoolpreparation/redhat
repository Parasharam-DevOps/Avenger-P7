# your_playbook.yml

- name: Install Apache Cassandra and Configure
  hosts: server4
  become: yes
  gather_facts: yes

  vars:
    java_package: java-11-openjdk-devel
    cassandra_repo_url: "https://redhat.cassandra.apache.org/41x/"
    cassandra_repo_key_url: "https://downloads.apache.org/cassandra/KEYS"
    cassandra_version: "4.1.3"
    cassandra_seeds: "172.31.4.145"
    cassandra_listen_address: "172.31.4.145"
    cassandra_rpc_address: "172.31.4.145"
    cassandra_endpoint_snitch: "RackInferringSnitch"
    cassandra_jvm_opts:
      - "-Dcassandra.ignore_dc=true"
      - "-Dcassandra.ignore_rack=true"

  tasks:
    - name: Update package list and install prerequisites
      yum:
        name: "@Development Tools"
        state: present

    - name: Run yum update
      yum:
        name: '*'
        state: latest
      tags: update_packages

    - name: Install Python 3
      yum:
        name: python3
        state: present

    - name: Install Java
      package:
        name: "{{ java_package }}"
        state: present
      tags: install_java
    
    - name: Add Cassandra repository
      yum_repository:
        name: cassandra
        description: "Apache Cassandra Repository"
        baseurl: "{{ cassandra_repo_url }}"
        gpgcheck: 1
        repo_gpgcheck: 1
        gpgkey: "{{ cassandra_repo_key_url }}"
        state: present


    - name: Download specific Cassandra version
      yum:
        name: "cassandra-{{ cassandra_version }}"
        state: present
      tags: install_cassandra

    - name: Start and enable Cassandra service using systemd
      systemd:
        name: cassandra
        state: started
        enabled: yes
      tags: start_cassandra_service

    - name: Add JVM options to cassandra-env.sh
      blockinfile:
        path: /etc/cassandra/default.conf/cassandra-env.sh
        insertbefore: EOF
        block: |
          {% for jvm_opt in cassandra_jvm_opts %}
          JVM_OPTS="$JVM_OPTS {{ jvm_opt }}"
          {% endfor %}
      notify: Restart Cassandra

    - name: Copy Cassandra configuration template
      template:
        src: /home/parsu/ansible/cassandra.yaml.j2
        dest: /etc/cassandra/cassandra.yaml
      notify: Restart Cassandra

    - name: Debug variables
      debug:
        var: "{{ item }}"
      with_items:
        - cluster_name
        - cassandra_seeds
        - cassandra_listen_address
        - cassandra_rpc_address
        - cassandra_endpoint_snitch

  handlers:
    - name: Restart Cassandra
      systemd:
        name: cassandra
        state: restarted
